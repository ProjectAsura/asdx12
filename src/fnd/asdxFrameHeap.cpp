//-----------------------------------------------------------------------------
// File : asdxFrameHeap.cpp
// Desc : Frame Heap.
// Copyright(c) Project Asura. All right reserved.
//-----------------------------------------------------------------------------

//-----------------------------------------------------------------------------
// Includes
//-----------------------------------------------------------------------------
#include <new>
#include <fnd/asdxFrameHeap.h>
#include <fnd/asdxLogger.h>


namespace asdx {

///////////////////////////////////////////////////////////////////////////////
// FrameHeap class
///////////////////////////////////////////////////////////////////////////////

//-----------------------------------------------------------------------------
//      コンストラクタです.
//-----------------------------------------------------------------------------
FrameHeap::FrameHeap()
: m_Size    (0)
, m_pBuffer (nullptr)
, m_Offset  (0)
{ /* DO_NOTHING */ }

//-----------------------------------------------------------------------------
//      デストラクタです.
//-----------------------------------------------------------------------------
FrameHeap::~FrameHeap()
{ Term(); }

//-----------------------------------------------------------------------------
//      初期化処理を行います.
//-----------------------------------------------------------------------------
bool FrameHeap::Init(size_t size)
{
    Term();

    m_pBuffer = new(std::nothrow) uint8_t[size];
    if (m_pBuffer == nullptr)
    {
        ELOG("Error : Out of memory.");
        return false;
    }

    m_Size   = size;
    m_Offset = 0;

    return true;
}

//-----------------------------------------------------------------------------
//      終了処理を行います.
//-----------------------------------------------------------------------------
void FrameHeap::Term()
{
    if (m_pBuffer != nullptr)
    {
        delete[] m_pBuffer;
        m_pBuffer = nullptr;
    }

    m_Size   = 0;
    m_Offset = 0;
}

//-----------------------------------------------------------------------------
//      バッファ先頭にオフセットをリセットします.
//-----------------------------------------------------------------------------
void FrameHeap::Reset()
{ m_Offset = 0; }

//-----------------------------------------------------------------------------
//      メモリ確保を行います.
//-----------------------------------------------------------------------------
void* FrameHeap::Alloc(size_t size)
{
    if (GetRestSize() < size)
    { return nullptr; }

    auto ptr = m_pBuffer + m_Offset;
    m_Offset += size;
    return ptr;
}

//-----------------------------------------------------------------------------
//      メモリサイズを取得します.
//-----------------------------------------------------------------------------
size_t FrameHeap::GetSize() const
{ return m_Size; }

//-----------------------------------------------------------------------------
//      利用可能なメモリサイズを取得します.
//-----------------------------------------------------------------------------
size_t FrameHeap::GetRestSize() const
{ return m_Size - m_Offset; }

} // namespace asdx
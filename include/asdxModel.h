//-----------------------------------------------------------------------------
// File : asdxModel.h
// Desc : Model.
// Copyright(c) Project Asura. All right reserved.
//-----------------------------------------------------------------------------
#pragma once

//-----------------------------------------------------------------------------
// Includes
//-----------------------------------------------------------------------------
#include <asdxResModel.h>
#include <asdxStructuredBuffer.h>
#include <asdxResourceUploader.h>


namespace asdx {

///////////////////////////////////////////////////////////////////////////////
// BoundingBox structure
///////////////////////////////////////////////////////////////////////////////
struct BoundingBox
{
    asdx::Vector3   mini;
    asdx::Vector3   maxi;
};

///////////////////////////////////////////////////////////////////////////////
// Mesh class
///////////////////////////////////////////////////////////////////////////////
class Mesh
{
    //=========================================================================
    // list of friend classes and methods.
    //=========================================================================
    /* NOTHING */

public:
    //=========================================================================
    // public variables.
    //=========================================================================
    /* NOTHING */

    //=========================================================================
    // public methods.
    //=========================================================================

    //-------------------------------------------------------------------------
    //! @brief      コンストラクタです.
    //-------------------------------------------------------------------------
    Mesh();

    //-------------------------------------------------------------------------
    //! @brief      デストラクタです.
    //-------------------------------------------------------------------------
    ~Mesh();

    //-------------------------------------------------------------------------
    //! @brief      初期化処理を行います.
    //!
    //! @param[in]      resource        スタティックメッシュリソースです.
    //! @retval true    初期化成功.
    //! @retval false   初期化失敗.
    //-------------------------------------------------------------------------
    bool Init(const ResMesh& resource);

    //-------------------------------------------------------------------------
    //! @brief      終了処理を行います.
    //-------------------------------------------------------------------------
    void Term();

    //-------------------------------------------------------------------------
    //! @brief      頂点データを取得します.
    //!
    //! @return     頂点データを返却します.
    //-------------------------------------------------------------------------
    const StructuredBuffer& GetPositions() const;

    //-------------------------------------------------------------------------
    //! @brief      接線空間を取得します.
    //!
    //! @return     接線空間を返却します.
    //-------------------------------------------------------------------------
    const StructuredBuffer& GetTangentSpaces() const;

    //-------------------------------------------------------------------------
    //! @brief      頂点カラーを取得します.
    //!
    //! @return     頂点カラー返却します.
    //-------------------------------------------------------------------------
    const StructuredBuffer& GetColors() const;

    //-------------------------------------------------------------------------
    //! @brief      テクスチャ座標を取得します.
    //!
    //! @return     テクスチャ座標を返却します.
    //-------------------------------------------------------------------------
    const StructuredBuffer& GetTexCoords(uint8_t index) const;

    //-------------------------------------------------------------------------
    //! @brief      ボーン番号を取得します.
    //!
    //! @return     ボーン番号を返却します.
    //-------------------------------------------------------------------------
    const StructuredBuffer& GetBoneIndices() const;

    //-------------------------------------------------------------------------
    //! @brief      ボーン重みを取得します.
    //!
    //! @return     ボーン重みを返却します.
    //-------------------------------------------------------------------------
    const StructuredBuffer& GetBoneWeights() const;

    //-------------------------------------------------------------------------
    //! @brief      インデックスデータを取得します.
    //!
    //! @return     インデックスデータを返却します.
    //-------------------------------------------------------------------------
    const StructuredBuffer& GetInindices() const;

    //-------------------------------------------------------------------------
    //! @brief      プリミティブデータを取得します.
    //!
    //! @return     プリミティブデータを返却します.
    //-------------------------------------------------------------------------
    const StructuredBuffer& GetPrimitives() const;

    //-------------------------------------------------------------------------
    //! @brief      メッシュレットデータを取得します.
    //!
    //! @return     メッシュレットデータを返却します.
    //-------------------------------------------------------------------------
    const StructuredBuffer& GetMeshlets() const;

    //-------------------------------------------------------------------------
    //! @brief      カリング情報を取得します.
    //!
    //! @return     カリング情報を返却します.
    //-------------------------------------------------------------------------
    const StructuredBuffer& GetCullingInfos() const;

    //-------------------------------------------------------------------------
    //! @brief      メッシュハッシュを取得します.
    //!
    //! @return     メッシュハッシュを返却します.
    //-------------------------------------------------------------------------
    uint32_t GetMeshHash() const;

    //-------------------------------------------------------------------------
    //! @brief      マテリアルハッシュを取得します.
    //!
    //! @return     マテリアルハッシュを返却します.
    //-------------------------------------------------------------------------
    uint32_t GetMaterialHash() const;

    //-------------------------------------------------------------------------
    //! @brief      メッシュレット数を取得します.
    //!
    //! @return     メッシュレット数を返却します.
    //-------------------------------------------------------------------------
    uint32_t GetMeshletCount() const;

    //-------------------------------------------------------------------------
    //! @brief      バウンディングボックスを取得します.
    //!
    //! @return     バウンディングボックスを返却します.
    //-------------------------------------------------------------------------
    const BoundingBox& GetBox() const;

    //-------------------------------------------------------------------------
    //! @brief      接線空間データを持つかどうか?
    //!
    //! @retval true    接線空間データを持ちます.
    //! @retval false   接線空間データを持ちません.
    //-------------------------------------------------------------------------
    bool HasTangentSpace() const;

    //-------------------------------------------------------------------------
    //! @brief      頂点カラーをもつかどうか?
    //!
    //! @retval true    頂点カラーを持ちます.
    //! @retval false   頂点カラーを持ちません.
    //------------------------------------------------------------------------
    bool HasColor() const;

    //-------------------------------------------------------------------------
    //! @brief      テクスチャ座標を持つかどうか.
    //!
    //! @param[in]      index       テクスチャ座標チャンネル.
    //! @retval true    テクスチャ座標を持ちます.
    //! @retval false   テクスチャ座標を持ちません.
    //-------------------------------------------------------------------------
    bool HasTexCoord(uint8_t index) const;

    //-------------------------------------------------------------------------
    //! @brief      ボーンを持つかどうか?
    //!
    //! @retval true    ボーンを持ちます.
    //! @retval false   ボーンを持ちません.
    //-------------------------------------------------------------------------
    bool HasBone() const;

private:
    //=========================================================================
    // private variables.
    //=========================================================================
    uint32_t            m_MeshHash;
    uint32_t            m_MaterialHash;
    uint32_t            m_MeshletCount;
    BoundingBox         m_Box;
    StructuredBuffer    m_Positions;
    StructuredBuffer    m_TangentSpaces;
    StructuredBuffer    m_TexCoords[4];
    StructuredBuffer    m_Colors;
    StructuredBuffer    m_BoneIndices;
    StructuredBuffer    m_BoneWeights;
    StructuredBuffer    m_Indices;
    StructuredBuffer    m_Primitives;
    StructuredBuffer    m_Meshlets;
    StructuredBuffer    m_CullingInfos;

    //=========================================================================
    // private methods.
    //=========================================================================
    /* NOTHING */
};


///////////////////////////////////////////////////////////////////////////////
// Model class
///////////////////////////////////////////////////////////////////////////////
class Model
{
    //=========================================================================
    // list of friend classes and methods.
    //=========================================================================
    /* NOTHING */

public:
    //=========================================================================
    // public variables.
    //=========================================================================
    /* NOTHING */

    //=========================================================================
    // public methods.
    //=========================================================================

    //-------------------------------------------------------------------------
    //! @brief      コンストラクタです.
    //-------------------------------------------------------------------------
    Model();

    //-------------------------------------------------------------------------
    //! @brief      デストラクタです.
    //-------------------------------------------------------------------------
    ~Model();

    //-------------------------------------------------------------------------
    //! @brief      初期化処理を行います.
    //!
    //! @param[in]      model       モデルリソースです.
    //! @retval true    初期化に成功.
    //! @retval false   初期化に失敗.
    //-------------------------------------------------------------------------
    bool Init(const ResModel& model);

    //-------------------------------------------------------------------------
    //! @brief      終了処理を行います.
    //-------------------------------------------------------------------------
    void Term();

    //-------------------------------------------------------------------------
    //! @brief      メッシュ数を取得します.
    //!
    //! @return     メッシュ数を返却します.
    //-------------------------------------------------------------------------
    uint32_t GetMeshCount() const;

    //-------------------------------------------------------------------------
    //! @brief      メッシュを取得します.
    //!
    //! @param[in]      index       メッシュ番号です.
    //! @return     指定されたメッシュを返却します.
    //-------------------------------------------------------------------------
    const Mesh& GetMesh(uint32_t index) const;

    //-------------------------------------------------------------------------
    //! @brief      バウンディングボックスを取得します.
    //!
    //! @return     バウンディングボックスを返却します.
    //-------------------------------------------------------------------------
    const BoundingBox& GetBox() const;

private:
    //=========================================================================
    // private variables
    //=========================================================================
    BoundingBox         m_Box;
    std::vector<Mesh>   m_Meshes;
    
    //=========================================================================
    // private methods.
    //=========================================================================
    /* NOTHING */
};

} // namespace asdx

//-----------------------------------------------------------------------------
// File : asdxResourceUploader.h
// Desc : Resource Uploader
// Copyright(c) Project Asura. All right reserved.
//-----------------------------------------------------------------------------
#pragma once

//-----------------------------------------------------------------------------
// Includes
//-----------------------------------------------------------------------------
#include <queue>
#include <list>
#include <mutex>
#include <d3d12.h>
#include <asdxRef.h>


namespace asdx {

///////////////////////////////////////////////////////////////////////////////
// IUploadResource interface
///////////////////////////////////////////////////////////////////////////////
struct IUploadResource : public IReference
{
    //-------------------------------------------------------------------------
    //! @brief      デストラクタです.
    //-------------------------------------------------------------------------
    virtual ~IUploadResource() 
    { /* DO_NOTHING */ }

    //-------------------------------------------------------------------------
    //! @brief      アップロードコマンドを発行します.
    //!
    //! @param[in]      pCmdList        コマンドリスト.
    //-------------------------------------------------------------------------
    virtual void Upload(ID3D12GraphicsCommandList* pCmdList) = 0;
};

///////////////////////////////////////////////////////////////////////////////
// ResourceUploader class
///////////////////////////////////////////////////////////////////////////////
class ResourceUploader
{
    //=========================================================================
    // list of friend classes and methods.
    //=========================================================================
    /* NOTHING */

public:
    //=========================================================================
    // public variables.
    //=========================================================================
    static constexpr uint8_t kDefaultLifeTime = 4;     //!< 4フレーム.

    //-------------------------------------------------------------------------
    //! @brief      コンストラクタです.
    //-------------------------------------------------------------------------
    ResourceUploader();

    //-------------------------------------------------------------------------
    //! @brief      デストラクタです.
    //-------------------------------------------------------------------------
    ~ResourceUploader();

    //-------------------------------------------------------------------------
    //! @brief      リソースを登録します.
    //!
    //! @param[in]      pResource   登録するリソース.
    //! @param[in]      lifeTime    生存フレーム数.
    //! @note       内部で参照カウントは上げません.
    //-------------------------------------------------------------------------
    void Push(IUploadResource* pResource, uint8_t lifeTime = kDefaultLifeTime);

    //-------------------------------------------------------------------------
    //! @brief      アップロード処理を実行します.
    //!
    //! @param[in]      pCmdList        コマンドリストです.
    //-------------------------------------------------------------------------
    void Upload(ID3D12GraphicsCommandList* pCmdList);

    //-------------------------------------------------------------------------
    //! @brief      フレーム同期し，遅延解放を実行します.
    //-------------------------------------------------------------------------
    void FrameSync();

    //-------------------------------------------------------------------------
    //! @brief      強制破棄を実行します.
    //!
    //! @note       内部でIUploadResource::Resource()を呼び出します.
    //-------------------------------------------------------------------------
    void Clear();

private:
    ///////////////////////////////////////////////////////////////////////////
    // Item structure
    ///////////////////////////////////////////////////////////////////////////
    struct Item
    {
        IUploadResource*    pResource;      //!< 破棄リソース.
        uint8_t             LifeTime;       //!< 生存フレーム数.
    };

    //=========================================================================
    // private varaibles.
    //=========================================================================
    std::queue<Item>    m_Queue;        //!< リソースキュー.
    std::list<Item>     m_List;         //!< 破棄リスト.

    //=========================================================================
    // private methods.
    //=========================================================================
    /* NOTHING */
};

} // namespace asdx
